<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Col McDermott">
<meta name="dcterms.date" content="2025-03-04">
<meta name="description" content="An introductory analysis of an automated decision model in the context of credit-risk prediction">

<title>Post 2 - Exploring Automated Decision Models – Middlebury College CSCI 0451 Blog - Col McDermott</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6943a74fafdbf25ea2a644024beb669f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: white;
      }

      .quarto-title-block .quarto-title-banner {
        color: white;
background-image: url(../../img/landscape.png);
background-size: cover;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Middlebury College CSCI 0451 Blog - Col McDermott</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Blog Info</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Col-McDermott"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Post 2 - Exploring Automated Decision Models</h1>
                  <div>
        <div class="description">
          An introductory analysis of an automated decision model in the context of credit-risk prediction
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Col McDermott </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 4, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The following study is an introductory exploration of an automated decision model. The primary aims of this analysis are to develop a deeper understanding of binary decision-making circumstances and how the use of ML models/algorithms can be used to assist and even automate this process. This analysis takes on a realistic problem using simulated data. Based on several characteristics of a potential borrower – like their financial status, reasons for seeking a loan, and age – is it wise or ill-advised to approve them for a given loan? The sections below attempt to produce a reasonable answer to this question through the creation of an automated decision-making model.</p>
<p>The general methodologies for this study involve an initial exploration of the data, constructing a model using certain features, and determining an optimal threshold based on a defined scoring function. It is necessary to observe some general patterns and trends present in the data before building a model. After the preliminary visualization and preprocessing steps, an initial model will be constructed and further refined using an iterative feature selection process supported by cross-validation. After an improved (by training accuracy) model is obtained, a scoring function will be defined using the weights determined by the best model version. With this scoring function, an optimal threshold can then be examined and set to maximize desirable values such as model accuracy and bank profit. Finally, with an optimal threshold selected and a refined model, the behavior of this model on unseen data can be evaluated. Following the final model’s evaluation this study concludes with a discussion of the implications behind automated decision algorithms with respect to general “fairness” from the perspective of all stakeholders (model designers, model users, and all impacted individuals, and etc.).</p>
<section id="accessing-the-data" class="level3">
<h3 class="anchored" data-anchor-id="accessing-the-data">Accessing the Data</h3>
<div id="cell-3" class="cell" data-execution_count="244">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Includuing all additional imports</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> LinearSegmentedColormap</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> pd.read_csv(<span class="st">"https://raw.githubusercontent.com/PhilChodrow/ml-notes/main/data/credit-risk/train.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><em>Including all additional imports</em></p>
<p>The data used in this analysis is a <a href="https://www.kaggle.com/datasets/laotse/credit-risk-dataset">simulated data set</a> of credit bureau data based on patterns observed in real credit bureau data.</p>
</section>
<section id="exploring-the-data" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-data">Exploring the Data</h2>
<section id="preliminary-visualizations" class="level3">
<h3 class="anchored" data-anchor-id="preliminary-visualizations">Preliminary Visualizations</h3>
<div id="cell-6" class="cell" data-execution_count="245">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data modification</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>train_viz <span class="op">=</span> train.copy()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>loan_status_recode <span class="op">=</span> {<span class="dv">0</span>: <span class="st">"Paid in Full"</span>, <span class="dv">1</span>: <span class="st">"Defaulted"</span>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>loan_intent_recode <span class="op">=</span> {<span class="st">"VENTURE"</span>: <span class="st">"Venture"</span>, <span class="st">"EDUCATION"</span>: <span class="st">"Education"</span>, <span class="st">"MEDICAL"</span>: <span class="st">"Medical"</span>, <span class="st">"HOMEIMPROVEMENT"</span>: <span class="st">"Home Improvement"</span>, <span class="st">"PERSONAL"</span>: <span class="st">"Personal"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a> <span class="st">"DEBTCONSOLIDATION"</span> : <span class="st">"Debt Consolidation"</span>}</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>train_viz[<span class="st">"loan_repayment"</span>] <span class="op">=</span> train_viz[<span class="st">"loan_status"</span>].<span class="bu">map</span>(loan_status_recode)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>train_viz[<span class="st">"loan_intent"</span>] <span class="op">=</span> train_viz[<span class="st">"loan_intent"</span>].<span class="bu">map</span>(loan_intent_recode)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>train_viz.loc[train_viz[<span class="st">"person_age"</span>] <span class="op">&gt;=</span> <span class="dv">100</span>, <span class="st">"person_age"</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>train_viz <span class="op">=</span> train_viz.dropna()</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Subsetting data by loan status</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>defaulted <span class="op">=</span> train_viz[train_viz[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>].copy().dropna()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>repaid <span class="op">=</span> train_viz[train_viz[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">0</span>].copy().dropna()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><em>Modifying training data for visualization</em></p>
<div id="cell-8" class="cell" data-execution_count="246">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating linear regression models and calculating R^2 values</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Defaulted</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>c1 <span class="op">=</span> np.polyfit(defaulted[<span class="st">"loan_amnt"</span>], defaulted[<span class="st">"person_income"</span>], <span class="dv">1</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> np.polyval(c1, defaulted[<span class="st">"loan_amnt"</span>])</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>r1 <span class="op">=</span> defaulted[<span class="st">"person_income"</span>] <span class="op">-</span> p1</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>ssr1 <span class="op">=</span> np.<span class="bu">sum</span>(r1 <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sst1 <span class="op">=</span> np.<span class="bu">sum</span>((defaulted[<span class="st">"person_income"</span>] <span class="op">-</span> np.mean(defaulted[<span class="st">"loan_amnt"</span>])) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>rs1 <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> (ssr1 <span class="op">/</span> sst1)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">## Repaid</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>c2 <span class="op">=</span> np.polyfit(repaid[<span class="st">"loan_amnt"</span>], repaid[<span class="st">"person_income"</span>], <span class="dv">1</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> np.polyval(c2, repaid[<span class="st">"loan_amnt"</span>])</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> repaid[<span class="st">"person_income"</span>] <span class="op">-</span> p2</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>ssr2 <span class="op">=</span> np.<span class="bu">sum</span>(r2<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>sst2 <span class="op">=</span> np.<span class="bu">sum</span>((repaid[<span class="st">"person_income"</span>] <span class="op">-</span> np.mean(repaid[<span class="st">"loan_amnt"</span>]))<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>rs2 <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> (ssr2 <span class="op">/</span> sst2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><em>Creating linear regression models and calculating R^2 values for subsets of defaulted and fully repaid loans</em></p>
<div id="cell-10" class="cell" data-execution_count="247">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"seaborn-v0_8-whitegrid"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot and regression line for borrower income by loan amount of defaulted loans</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>] <span class="op">=</span> sns.scatterplot(data <span class="op">=</span> defaulted, x <span class="op">=</span> <span class="st">"loan_amnt"</span>, y <span class="op">=</span> <span class="st">"person_income"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, edgecolor <span class="op">=</span> <span class="st">"purple"</span>, alpha <span class="op">=</span> <span class="fl">0.25</span>, ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>sns.regplot(data <span class="op">=</span> defaulted, x <span class="op">=</span> <span class="st">"loan_amnt"</span>, y <span class="op">=</span> <span class="st">"person_income"</span>, scatter <span class="op">=</span> <span class="va">False</span>, line_kws<span class="op">=</span>{<span class="st">"color"</span>: <span class="st">"darkorange"</span>}, ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_yscale(<span class="st">"log"</span>, base <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xticks([<span class="dv">0</span>, <span class="dv">5000</span>, <span class="dv">10000</span>, <span class="dv">15000</span>, <span class="dv">20000</span>, <span class="dv">25000</span>, <span class="dv">30000</span>, <span class="dv">35000</span>])</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xticklabels([<span class="st">"$0"</span>, <span class="st">"$5000"</span>, <span class="st">"$10000"</span>, <span class="st">"$15000"</span>, <span class="st">"$20000"</span>, <span class="st">"$25000"</span>, <span class="st">"$30000"</span>, <span class="st">"$35000"</span>], rotation <span class="op">=</span> <span class="dv">30</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="ss">f"Borrower</span><span class="ch">\'</span><span class="ss">s Income ($\log_2$ scale)"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>, labelpad <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_yticks([<span class="dv">2</span><span class="op">**</span><span class="dv">12</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">13</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">14</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">15</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">17</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">18</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">19</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">20</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">21</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">22</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">23</span>])</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_yticklabels([<span class="st">"&gt;$4000"</span>, <span class="st">"&gt;$8000"</span>, <span class="st">"&gt;$16000"</span>, <span class="st">"&gt;$32000"</span>, <span class="st">"&gt;$64000"</span>, <span class="st">"&gt;$128000"</span>, <span class="st">"&gt;$256000"</span>, <span class="st">"&gt;$512000"</span>, <span class="st">"&gt;$1024000"</span>, <span class="st">"&gt;$2048000"</span>, <span class="st">"&gt;$4096000"</span>, <span class="st">"&lt;$8192000"</span>], rotation <span class="op">=</span> <span class="dv">15</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Defaulted Loans"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].text(<span class="dv">27000</span>, <span class="dv">12288</span>, <span class="ss">f"     $R^2 = </span><span class="sc">{</span>rs1<span class="sc">:.3f}</span><span class="ss">$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].text(<span class="dv">24000</span>, <span class="dv">12288</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color<span class="op">=</span><span class="st">"darkorange"</span>, ha<span class="op">=</span><span class="st">"left"</span>, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot and regression line for borrower income by loan amount of repaid loans</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>] <span class="op">=</span> sns.scatterplot(data <span class="op">=</span> repaid, x <span class="op">=</span> <span class="st">"loan_amnt"</span>, y <span class="op">=</span> <span class="st">"person_income"</span>, color <span class="op">=</span> <span class="st">"darkorange"</span>, edgecolor <span class="op">=</span> <span class="st">"darkorange"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>sns.regplot(data <span class="op">=</span> repaid, x <span class="op">=</span> <span class="st">"loan_amnt"</span>, y <span class="op">=</span> <span class="st">"person_income"</span>, scatter <span class="op">=</span> <span class="va">False</span>, line_kws<span class="op">=</span>{<span class="st">"color"</span>: <span class="st">"purple"</span>}, ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_yscale(<span class="st">"log"</span>, base <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xticks([<span class="dv">0</span>, <span class="dv">5000</span>, <span class="dv">10000</span>, <span class="dv">15000</span>, <span class="dv">20000</span>, <span class="dv">25000</span>, <span class="dv">30000</span>, <span class="dv">35000</span>])</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xticklabels([<span class="st">"$0"</span>, <span class="st">"$5000"</span>, <span class="st">"$10000"</span>, <span class="st">"$15000"</span>, <span class="st">"$20000"</span>, <span class="st">"$25000"</span>, <span class="st">"$30000"</span>, <span class="st">"$35000"</span>], rotation<span class="op">=</span><span class="dv">30</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">""</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_yticks([<span class="dv">2</span><span class="op">**</span><span class="dv">12</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">13</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">14</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">15</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">17</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">18</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">19</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">20</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">21</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">22</span>, <span class="dv">2</span><span class="op">**</span><span class="dv">23</span>])</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_yticklabels(<span class="dv">12</span> <span class="op">*</span> [<span class="st">""</span>], rotation <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Repaid Loans"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].text(<span class="dv">27000</span>, <span class="dv">12288</span>, <span class="ss">f"     $R^2 = </span><span class="sc">{</span>rs2<span class="sc">:.3f}</span><span class="ss">$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].text(<span class="dv">24000</span>, <span class="dv">12288</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color<span class="op">=</span><span class="st">"purple"</span>, ha<span class="op">=</span><span class="st">"left"</span>, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Borrower</span><span class="ch">\'</span><span class="st">s Income by Loan Amount Displayed by Loan Repayment Status"</span>, fontsize <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.47</span>, <span class="fl">0.025</span>, <span class="st">"Loan Amount"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(wspace<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Figure 1</strong></p>
<p>The plots above display the relationship between a borrower’s income and the loan amount borrowed for both defaulted and fully repaid loans. To assist the visualization of the data points, the dependent variable <code>person_income</code> is adjusted using a <span class="math inline">\(\log_2\)</span> scale. With this scale in place and for both defaulted and fully repaid loans, there appears to be a transformed linear relationship between a borrower’s income and the loan amount borrowed. Additionally, this transformed linear relationship appears to be positive and moderately strong (given both <span class="math inline">\(R^2\)</span> values &gt; 0.6). For both borrowers who defaulted on loans and borrowers who fully repaid their loans, it appears that as the loan amount increases, a borrower’s income increases (adjusted by a <span class="math inline">\(\log_2\)</span> scale). Considering this observed relationship, it is reasonable to assert that bigger loans are borrowed by individuals with higher income levels, regardless of whether or not those individuals defaulted or fully repaid their loans.</p>
<div id="cell-12" class="cell" data-execution_count="248">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subsetting data to the three most common loan intents</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>common_loan_intents <span class="op">=</span> train_viz.copy()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>common_loan_intents <span class="op">=</span> train_viz[train_viz[<span class="st">"loan_intent"</span>].isin([<span class="st">"Education"</span>, <span class="st">"Medical"</span>, <span class="st">"Venture"</span>])].copy()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating Boxen Plot</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="fl">7.5</span>))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"seaborn-v0_8-whitegrid"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> sns.boxenplot(common_loan_intents, x <span class="op">=</span> <span class="st">"loan_intent"</span>, y <span class="op">=</span> <span class="st">"person_age"</span>, hue <span class="op">=</span> <span class="st">"loan_repayment"</span>, palette <span class="op">=</span> [<span class="st">"darkorange"</span>, <span class="st">"purple"</span>])</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>p.set_xlabel(<span class="st">"Intention for Loan"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>p.set_ylabel(<span class="st">"Borrower</span><span class="ch">\'</span><span class="st">s Age"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>p.set_xticks([<span class="st">"Education"</span>, <span class="st">"Medical"</span>, <span class="st">"Venture"</span>])</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>p.legend(title <span class="op">=</span> <span class="st">"Loan Status"</span>, frameon <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>p.set_title(<span class="st">"Distribution of Borrower</span><span class="ch">\'</span><span class="st">s Age for Top Three Loan Intents</span><span class="ch">\n</span><span class="st">Grouped by Loan Repayment Status"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Figure 2</strong></p>
<p>The figure above shows an <code>sns.boxenplot</code> displaying the distribution of borrower’s age for the three most common loan intents across both defaulted and fully repaid loans.</p>
<p><u>For education loans:</u> The median age of both borrowers who defaulted on loans and borrowers who fully repaid their loans is less than or equal to that of defaulting and repaying borrowers taking out medical and venture loans. Additionally, the median age of educational loan borrowers is lower for those who fully repaid their loans than it is for those who defaulted – Thus, a topic for another analysis could be to explore how the age of educational loan borrowers has an impact on such loans being repaid.</p>
<p><u>For medical loans:</u> It appears that the median age of borrowers is greater than those taking out loans for education or venture. There is also very little visually observable difference in the median age of borrowers who defaulted and borrowers who fully repaid their medical loans.</p>
<p><u>For venture loans:</u> The median age of borrowers who fully repaid their loans is greater than that of those who defaulted on their loans. Similarly to the topic posed for educational loan borrowers, it could be interesting to explore in a future study how the age of venture loan borrowers has an effect on such loans being repaid.</p>
</section>
<section id="table-of-general-summary-statistics" class="level3">
<h3 class="anchored" data-anchor-id="table-of-general-summary-statistics">Table of General Summary Statistics</h3>
<div id="cell-15" class="cell" data-execution_count="249">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary Statistics</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper method to calculate coefficient of variation (%)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cv(col):</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (col.std() <span class="op">/</span> col.mean()) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a table grouped by penguin species and sex, showing general summary stats for several quantitative variables</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>sum_stats <span class="op">=</span> train_viz.rename(columns <span class="op">=</span> {<span class="st">"loan_repayment"</span>: <span class="st">"Loan Repayment"</span>, <span class="st">"loan_amnt"</span>: <span class="st">"Loan Amount"</span>, <span class="st">"person_income"</span>: <span class="st">"Borrower</span><span class="ch">\'</span><span class="st">s Income"</span>, <span class="st">"loan_intent"</span>: <span class="st">"Loan Intent"</span>, <span class="st">"person_age"</span>: <span class="st">"Borrower</span><span class="ch">\'</span><span class="st">s Age"</span>, <span class="st">"loan_percent_income"</span>: <span class="st">"Loan Percent Income"</span>}).copy()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>sum_stats <span class="op">=</span> sum_stats.groupby([<span class="st">"Loan Repayment"</span>, <span class="st">"Loan Intent"</span>]).aggregate({<span class="st">"Loan Amount"</span> : [<span class="st">"mean"</span>, <span class="st">"std"</span>, cv], </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                                                             <span class="st">"Borrower</span><span class="ch">\'</span><span class="st">s Income"</span> : [<span class="st">"mean"</span>, <span class="st">"std"</span>, cv], <span class="st">"Loan Percent Income"</span>: [<span class="st">"mean"</span>, <span class="st">"std"</span>, cv], </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                                                             <span class="st">"Borrower</span><span class="ch">\'</span><span class="st">s Age"</span>: [<span class="st">"mean"</span>, <span class="st">"std"</span>, cv]})</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>sum_stats <span class="op">=</span> sum_stats.rename(columns <span class="op">=</span> {<span class="st">"mean"</span>: <span class="st">"Mean"</span>, <span class="st">"std"</span>: <span class="st">"STD"</span>, <span class="st">"cv"</span>: <span class="st">"CV (%)"</span>})</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>sum_stats <span class="op">=</span> sum_stats.<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>sum_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="249">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th colspan="3" data-quarto-table-cell-role="th" data-halign="left">Loan Amount</th>
<th colspan="3" data-quarto-table-cell-role="th" data-halign="left">Borrower's Income</th>
<th colspan="3" data-quarto-table-cell-role="th" data-halign="left">Loan Percent Income</th>
<th colspan="3" data-quarto-table-cell-role="th" data-halign="left">Borrower's Age</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">STD</th>
<th data-quarto-table-cell-role="th">CV (%)</th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">STD</th>
<th data-quarto-table-cell-role="th">CV (%)</th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">STD</th>
<th data-quarto-table-cell-role="th">CV (%)</th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">STD</th>
<th data-quarto-table-cell-role="th">CV (%)</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">Loan Repayment</th>
<th data-quarto-table-cell-role="th">Loan Intent</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="6" data-quarto-table-cell-role="th" data-valign="top">Defaulted</td>
<td data-quarto-table-cell-role="th">Debt Consolidation</td>
<td>11283.45</td>
<td>7357.29</td>
<td>65.20</td>
<td>54553.15</td>
<td>37624.33</td>
<td>68.97</td>
<td>0.24</td>
<td>0.13</td>
<td>57.00</td>
<td>27.76</td>
<td>6.52</td>
<td>23.49</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Education</td>
<td>10912.82</td>
<td>6979.08</td>
<td>63.95</td>
<td>47283.67</td>
<td>30264.34</td>
<td>64.01</td>
<td>0.26</td>
<td>0.13</td>
<td>51.90</td>
<td>27.09</td>
<td>6.10</td>
<td>22.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Home Improvement</td>
<td>10035.04</td>
<td>7324.85</td>
<td>72.99</td>
<td>49794.13</td>
<td>33062.93</td>
<td>66.40</td>
<td>0.22</td>
<td>0.13</td>
<td>57.24</td>
<td>27.62</td>
<td>6.04</td>
<td>21.86</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Medical</td>
<td>11438.49</td>
<td>7190.60</td>
<td>62.86</td>
<td>52477.12</td>
<td>44092.21</td>
<td>84.02</td>
<td>0.24</td>
<td>0.13</td>
<td>54.74</td>
<td>27.70</td>
<td>6.31</td>
<td>22.78</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Personal</td>
<td>10459.89</td>
<td>6884.86</td>
<td>65.82</td>
<td>46965.14</td>
<td>39080.81</td>
<td>83.21</td>
<td>0.25</td>
<td>0.13</td>
<td>51.99</td>
<td>27.24</td>
<td>6.09</td>
<td>22.37</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Venture</td>
<td>11115.68</td>
<td>6695.34</td>
<td>60.23</td>
<td>44439.34</td>
<td>27743.83</td>
<td>62.43</td>
<td>0.28</td>
<td>0.13</td>
<td>47.39</td>
<td>26.74</td>
<td>5.45</td>
<td>20.38</td>
</tr>
<tr class="odd">
<td rowspan="6" data-quarto-table-cell-role="th" data-valign="top">Paid in Full</td>
<td data-quarto-table-cell-role="th">Debt Consolidation</td>
<td>9050.14</td>
<td>5810.33</td>
<td>64.20</td>
<td>72388.92</td>
<td>61644.36</td>
<td>85.16</td>
<td>0.14</td>
<td>0.08</td>
<td>58.11</td>
<td>27.54</td>
<td>5.66</td>
<td>20.56</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Education</td>
<td>9206.44</td>
<td>6010.44</td>
<td>65.29</td>
<td>67866.15</td>
<td>41045.51</td>
<td>60.48</td>
<td>0.15</td>
<td>0.09</td>
<td>57.71</td>
<td>26.43</td>
<td>5.49</td>
<td>20.79</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Home Improvement</td>
<td>10518.51</td>
<td>6398.11</td>
<td>60.83</td>
<td>82499.92</td>
<td>50452.00</td>
<td>61.15</td>
<td>0.14</td>
<td>0.09</td>
<td>61.15</td>
<td>29.47</td>
<td>5.48</td>
<td>18.60</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Medical</td>
<td>8570.88</td>
<td>5645.54</td>
<td>65.87</td>
<td>65116.70</td>
<td>51476.94</td>
<td>79.05</td>
<td>0.15</td>
<td>0.08</td>
<td>56.46</td>
<td>27.96</td>
<td>6.17</td>
<td>22.07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Personal</td>
<td>9441.60</td>
<td>6133.81</td>
<td>64.97</td>
<td>72343.94</td>
<td>54121.45</td>
<td>74.81</td>
<td>0.15</td>
<td>0.09</td>
<td>57.83</td>
<td>28.49</td>
<td>7.42</td>
<td>26.03</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Venture</td>
<td>9307.47</td>
<td>6064.40</td>
<td>65.16</td>
<td>70493.68</td>
<td>58762.60</td>
<td>83.36</td>
<td>0.15</td>
<td>0.09</td>
<td>59.45</td>
<td>27.74</td>
<td>5.98</td>
<td>21.57</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><em>In creating the table above, I did some <a href="https://www.investopedia.com/terms/c/coefficientofvariation.asp#toc-coefficient-of-variation-cv-vs-standard-deviation">brief research</a> on CV to more easily interpret the STD and wrote the helper method</em></p>
<p><strong>Table 1</strong></p>
<p>The table above presents some general summary statistics from the data. I was interested in examining the mean, STD, and CV for some of the primary quantitative features in the data (<code>loan_amnt</code>, <code>person_income</code>, <code>loan_percent_income</code>, <code>person_age</code>) across each loan intent for both defaulted and fully repaid loans.</p>
<p><u>For Defaulted Loans:</u></p>
<ul>
<li>Medical loans are greatest in size on average compared to the other loan intents.
<ul>
<li>Home Improvement loans are the smallest in size on average.</li>
</ul></li>
<li>Debt Consolidation loans are taken out by borrowers with the greatest average income.
<ul>
<li>Venture loans are taken out by borrowers with the smallest average income.</li>
</ul></li>
<li>Venture loans have the largest average loan-value-percent-income in borrowers
<ul>
<li>Home improvement loans have the smallest average loan-value-percent-income among borrowers</li>
</ul></li>
<li>Debt Consolidation loans are taken out by borrowers with the largest age on average.
<ul>
<li>Venture loans correspond to borrowers with the lowest age on average.</li>
</ul></li>
</ul>
<p><u>For Fully Repaid Loans:</u></p>
<ul>
<li>Home Improvement loans are greatest in size on average compared to the other loan intents.
<ul>
<li>Medical loans are the smallest in size on average. (Interestingly, this is the complete opposite of defaulted loans)</li>
</ul></li>
<li>Home Improvement loans are taken out by borrowers with the greatest average income.
<ul>
<li>Medical loans are taken out by borrowers with the smallest average income.</li>
</ul></li>
<li>Medical, venture, education, and personal loans share the largest average loan-value-percent-income in borrowers while home improvement and debt consolidation loans correspond to the smallest average loan-value-percent-income in borrowers.</li>
</ul>
<p>In terms of the spread of data across the variables displayed in the table, all four features possess relatively high coefficient of variation (CV%) values. This suggests that there is a notable degree of variability in the distribution of each of these features. However, some features appear to vary more than others: <code>Loan Amount</code>, <code>Borrower's Income</code>, and <code>Loan Percent Income</code> all have average CV (%) values &gt; 50% while <code>Borrower's Age</code> has an average CV (%) <span class="math inline">\(\approx\)</span> 20%. Additionally, there appears to be no considerable difference in CV (%) across each of the recorded loan intents nor between defaulted and fully repaid loans in general.</p>
</section>
</section>
</section>
<section id="model-construction" class="level1">
<h1>Model Construction</h1>
<section id="feature-selection" class="level2">
<h2 class="anchored" data-anchor-id="feature-selection">Feature Selection</h2>
<div id="cell-18" class="cell" data-execution_count="250">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modifying the training data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> train.drop([<span class="st">"loan_status"</span>, <span class="st">"loan_grade"</span>], axis <span class="op">=</span> <span class="dv">1</span>, errors <span class="op">=</span> <span class="st">"ignore"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> train[<span class="st">"loan_status"</span>]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating one-hot encodings for qualitative variables</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> pd.get_dummies(X, drop_first <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing NAs from data while maintaining alignment</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>clean <span class="op">=</span> pd.concat([X, y], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>clean <span class="op">=</span> clean.dropna()</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> clean.drop(<span class="st">"loan_status"</span>, axis <span class="op">=</span> <span class="dv">1</span>, errors <span class="op">=</span> <span class="st">"ignore"</span>).copy()</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> clean[<span class="st">"loan_status"</span>].copy()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding new columns to X_train</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">## Ratio of employment length to credit history</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>X_train[<span class="st">"credit_hist_emp_len"</span>] <span class="op">=</span>  X_train[<span class="st">"person_emp_length"</span>] <span class="op">/</span> X_train[<span class="st">"cb_person_cred_hist_length"</span>]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Identifying quantitative and qualitative variables in the data</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>quant_vars <span class="op">=</span> [</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>              <span class="st">"person_age"</span>, </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>              <span class="st">"person_income"</span>, </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>              <span class="st">"person_emp_length"</span>, </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_amnt"</span>, </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_int_rate"</span>, </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_percent_income"</span>, </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cb_person_cred_hist_length"</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>              <span class="st">"credit_hist_emp_len"</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>qual_vars <span class="op">=</span> [</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>              <span class="st">"person_home_ownership_OTHER"</span>,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>              <span class="st">"person_home_ownership_OWN"</span>,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>              <span class="st">"person_home_ownership_RENT"</span>,</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_intent_EDUCATION"</span>,</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_intent_HOMEIMPROVEMENT"</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_intent_MEDICAL"</span>,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_intent_PERSONAL"</span>,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loan_intent_VENTURE"</span>,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cb_person_default_on_file_Y"</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Combination of selected quant and qual variables</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> quant_vars <span class="op">+</span> qual_vars</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Toggle to run feature selection process</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="va">False</span>):</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterating through all possible subsets of cols, evaluating a model with each subset, to determine the optimal set of variables to use</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  best_vars <span class="op">=</span> []</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  best_avg_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Paramters to determine the size of tested subsets</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  lower_bound <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  upper_bound <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(lower_bound, upper_bound):</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Iterating through all subsets</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> subset <span class="kw">in</span> itertools.combinations(cols, i):</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        curr_vars <span class="op">=</span> <span class="bu">list</span>(subset)</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fitting a model to each subset</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        LR <span class="op">=</span> LogisticRegression(random_state <span class="op">=</span> <span class="dv">69</span>)</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        LR.fit(X_train[curr_vars], y_train)</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        curr_avg_score <span class="op">=</span> cross_val_score(LR, X_train[curr_vars], y_train, cv <span class="op">=</span> <span class="dv">5</span>).mean()</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update the best average score and the best variables to use for the model</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (curr_avg_score <span class="op">&gt;</span> best_avg_score):</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>          best_avg_score <span class="op">=</span> curr_avg_score</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>          best_vars <span class="op">=</span> curr_vars</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the best 5 variables selected after the iterative feature selection process above</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>best_vars <span class="op">=</span> [<span class="st">"loan_percent_income"</span>, <span class="st">"cb_person_cred_hist_length"</span>, <span class="st">"person_home_ownership_OTHER"</span>, <span class="st">"person_home_ownership_RENT"</span>, <span class="st">"loan_intent_HOMEIMPROVEMENT"</span>]</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Refined model</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>LR <span class="op">=</span> LogisticRegression(random_state <span class="op">=</span> <span class="dv">69</span>)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>LR.fit(X_train[best_vars], y_train)</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>score <span class="op">=</span> LR.score(X_train[best_vars], y_train)</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Refined Model Accuracy: </span><span class="sc">{</span>score <span class="op">*</span> <span class="dv">100</span><span class="sc">: .3f}</span><span class="ss">%"</span>)</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the weights vector</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.array(LR.coef_[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Refined Model Accuracy:  85.096%</code></pre>
</div>
</div>
<p><em>Code above shows the iterative process of trying all combinations of certain sizes for all features and taking those that lead to the best cross-validated model performance</em></p>
<p>To begin the feature selection process, the training data was informally divided into its quantitative and qualitative variables. The feature selection process involved iterating through a subset of the power set (all possible subsets) of the training data. All combinations of 1 up to 5 (out of 17) features were evaluated (beyond 5 features was too computationally expensive). According to the feature selection above, the 5 best variables to train the model with are <code>loan_percent_income</code>, <code>cb_person_cred_hist_length</code> (length of borrower’s credit history), <code>person_home_ownership_OTHER</code> (borrowers with home ownership status as “OTHER”), <code>person_home_ownership_RENT</code> (borrowers who are renting a home), and <code>loan_intent_HOMEIMPROVEMENT</code> (borrowers who intend to use a loan for home improvement). With these features used, the <code>LogisticRegression</code> model achieved just over <span class="math inline">\(85\%\)</span> training accuracy. While there is certainly room to improve the model’s training accuracy, this is the highest score achieved using the variables provided by the data and without undertaking a massive computational load (i.e.&nbsp;super long run time to iterate through all elements of the variable power set). The weights used by the model were extracted and stored in a weights vector <code>w</code> to be used in the scoring function described below.</p>
</section>
<section id="creating-a-scoring-function" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-scoring-function">Creating a Scoring Function</h2>
<div id="cell-21" class="cell" data-execution_count="251">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute the score for each observation</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lin_score(X, w):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X<span class="op">@</span>w</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Computing scores of each training observation and observing confusion matrix for the training data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> lin_score(X_train[best_vars], w)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizing the scores</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> (scores <span class="op">-</span> scores.<span class="bu">min</span>()) <span class="op">/</span> (scores.<span class="bu">max</span>() <span class="op">-</span> scores.<span class="bu">min</span>())</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Observing confusion matrix for the training data</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>LR_pred <span class="op">=</span> LR.predict(X_train[best_vars])</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> confusion_matrix(y_train, LR_pred)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Establishing model predictions for the train data</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>y_train_pred <span class="op">=</span> LR.predict(X_train[best_vars])</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> confusion_matrix(y_train, y_train_pred)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>loan_status <span class="op">=</span> [<span class="st">"Fully Repaid"</span>, <span class="st">"Defaulted"</span>]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a heatmap for better confusion matrix visualization</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize <span class="op">=</span> (<span class="fl">7.5</span>, <span class="fl">7.5</span>))</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>mask1 <span class="op">=</span> np.zeros_like(C, dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>mask1[:, <span class="dv">1</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>mask2 <span class="op">=</span> np.zeros_like(C, dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>mask2[:, <span class="dv">0</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>purples <span class="op">=</span> LinearSegmentedColormap.from_list(<span class="st">"purple_gradient"</span>, [<span class="st">"#ce93d8"</span>, <span class="st">"#4a148c"</span>])</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>darkoranges <span class="op">=</span> LinearSegmentedColormap.from_list(<span class="st">"darkorange_gradient"</span>, [<span class="st">"#FFD580"</span>, <span class="st">"darkorange"</span>])</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the first column with purple gradient</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> sns.heatmap(C, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">"d"</span>, cmap<span class="op">=</span>purples, </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                mask<span class="op">=</span>mask1, cbar<span class="op">=</span><span class="va">False</span>, xticklabels<span class="op">=</span>[<span class="st">"Fully Repaid"</span>, <span class="st">"Defaulted"</span>],</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                yticklabels<span class="op">=</span>loan_status)</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the second column with orange gradient</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> sns.heatmap(C, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">"d"</span>, cmap<span class="op">=</span>darkoranges, </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                mask<span class="op">=</span>mask2, cbar<span class="op">=</span><span class="va">False</span>, xticklabels<span class="op">=</span>[<span class="st">"Fully Repaid"</span>, <span class="st">"Defaulted"</span>],</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                yticklabels<span class="op">=</span>loan_status)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting labels and title</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Predicted Loan Status"</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"True Loan Status"</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Lending Data Classification Confusion Matrix"</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing confusion matrix results</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There were </span><span class="sc">{</span>C[<span class="dv">0</span>, <span class="dv">0</span>]<span class="sc">}</span><span class="ss"> fully repaid loan(s) that were predicted to be fully repaid."</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There were </span><span class="sc">{</span>C[<span class="dv">0</span>, <span class="dv">1</span>]<span class="sc">}</span><span class="ss"> fully repaid loan(s) that were predicted to be defaulted."</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There were </span><span class="sc">{</span>C[<span class="dv">1</span>, <span class="dv">0</span>]<span class="sc">}</span><span class="ss"> defaulted loan(s) that were predicted to be fully repaid."</span>)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There were </span><span class="sc">{</span>C[<span class="dv">1</span>, <span class="dv">1</span>]<span class="sc">}</span><span class="ss"> defaulted loan(s) that were predicted to be defaulted."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>There were 17702 fully repaid loan(s) that were predicted to be fully repaid.
There were 279 fully repaid loan(s) that were predicted to be defaulted.
There were 3135 defaulted loan(s) that were predicted to be fully repaid.
There were 1791 defaulted loan(s) that were predicted to be defaulted.</code></pre>
</div>
</div>
<p><em>Code above shows the linear scoring function used to determine model predictions and evaluate model accuracy. The scores were normalized to ensure that all scores are within the interval [0, 1]</em></p>
<p><strong>Figure 3</strong></p>
<p>For this analysis, a linear scoring function is used. Specifically, the linear scoring function computes the score of each data observation by taking the dot product of each observation with the weights vector <code>w</code>. To ensure that all scores are values on the interval [0, 1], the scores are normalized after they are calculated (i.e.&nbsp;the scores are updated to be the difference between each raw score and the minimum raw score divided by the range of raw scores). Additionally, the confusion matrix for the model’s performance is displayed above. The model’s false positive rate is approximately <span class="math inline">\(1.55\%\)</span> while the true positive rate is approximately <span class="math inline">\(36.34\%\)</span>. Conversely, the model’s false negative rate is approximately <span class="math inline">\(63.66\%\)</span> while the true negative rate is approximately <span class="math inline">\(98.45\%\)</span>. With this information, it appears that the model rarely misclassifies fully repaid loans as defaulted (low FPR). However, the model frequently (moderately high FNR) misclassifies defaulted loans as being fully repaid. In general, with a very high TNR, the model is very accurate at detecting truly fully repaid loans but much less accurate (low TPR) at recognizing truly defaulted loans. It is important to note here that the initial objective for this model was to accurately predict if a prospective borrower will default on a loan, thus suggesting that perhaps the model and or the scoring function should be slightly redesigned to increase the TPR. However, given the introductory nature of this brief study, the analysis will continue with the current model as is.</p>
<section id="plotting-distribution-of-scores" class="level3">
<h3 class="anchored" data-anchor-id="plotting-distribution-of-scores">Plotting Distribution of Scores</h3>
<div id="cell-24" class="cell" data-execution_count="252">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of Scores - Code Provided by Prof. Chodrow</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize <span class="op">=</span> (<span class="fl">7.5</span>, <span class="dv">5</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"seaborn-v0_8-whitegrid"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>hist <span class="op">=</span> ax.hist(scores, bins <span class="op">=</span> <span class="dv">50</span>, color <span class="op">=</span> <span class="st">"darkorange"</span>, alpha <span class="op">=</span> <span class="fl">0.75</span>, linewidth <span class="op">=</span> <span class="dv">1</span>, edgecolor <span class="op">=</span> <span class="st">"purple"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> ax.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="vs">r"Scores (Normalized)"</span>, ylabel <span class="op">=</span> <span class="st">"Frequency"</span>) </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Percentage (the majority) of scores below 0.5</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>maj_scores <span class="op">=</span> (scores <span class="op">&lt;=</span> <span class="fl">0.5</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Figure 4</strong></p>
<p>As observed in the distribution of normalized scores above, it appears that the strong majority (<span class="math inline">\(\approx 91.81\%\)</span>)of normalized scores are less than or equal to 0.5. This may indicate that a useful threshold value for maximizing model accuracy and or bank profit per borrower (as informed by the model) might be close to <span class="math inline">\(t = 0.5\)</span>.</p>
</section>
</section>
<section id="choosing-a-threshold" class="level2">
<h2 class="anchored" data-anchor-id="choosing-a-threshold">Choosing a Threshold</h2>
<div id="cell-27" class="cell" data-execution_count="253">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold selection based on model accuracy</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>best_accuracy <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>best_threshold <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Following code is adapted from Prof. Chodrow</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize <span class="op">=</span> (<span class="fl">7.5</span>, <span class="dv">5</span>))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">100</span>): </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> scores <span class="op">&gt;=</span> t</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> (y_pred <span class="op">==</span> y_train).mean()</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    ax.scatter(t, acc, color <span class="op">=</span> <span class="st">"purple"</span>, s <span class="op">=</span> <span class="fl">12.5</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> acc <span class="op">&gt;</span> best_accuracy: </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        best_accuracy <span class="op">=</span> acc</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        best_threshold <span class="op">=</span> t</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>ax.axvline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"darkorange"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>, zorder <span class="op">=</span> <span class="op">-</span><span class="dv">10</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> ax.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="vs">r"Threshold $t$"</span>, ylabel <span class="op">=</span> <span class="st">"Model Accuracy"</span>, title <span class="op">=</span> <span class="st">"Accuracy by Threshold"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>ax.text(<span class="fl">0.75</span>, <span class="fl">0.5</span>, <span class="ss">f"Best Accuracy: </span><span class="sc">{</span>best_accuracy<span class="sc">: .3f}</span><span class="ch">\n</span><span class="ss">  At Threshold $t = $</span><span class="sc">{</span>best_threshold<span class="sc">: .3f}</span><span class="ss">"</span>, ha <span class="op">=</span> <span class="st">"center"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"grey"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Figure 5</strong></p>
<p>Shown above is the trend in overall model accuracy as the threshold <span class="math inline">\(t\)</span> increases from <span class="math inline">\(0: 1\)</span>. As outlined in the plot, the peak model accuracy (<span class="math inline">\(\approx 85\%\)</span>) is achieved using a threshold of <span class="math inline">\(t = 0.505\)</span>. However, what is likely more interesting (especially for the bank) is how the profit-per-borrower can be maximized through selecting a value for <span class="math inline">\(t\)</span>. Below is an examination of thresholding for profit maximization.</p>
<div id="cell-29" class="cell" data-execution_count="254">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold selection based on profit for the bank created by the model</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Updated variables</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>best_ppb <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>best_threshold <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Following code is adapted from Prof. Chodrow</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize <span class="op">=</span> (<span class="fl">7.5</span>, <span class="dv">5</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">100</span>): </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> scores <span class="op">&gt;=</span> t</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determining whether each prediction is a a true or false negative to inform the amount of profit loss or gain for a given loan</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    X_train[<span class="st">"TN"</span>] <span class="op">=</span> ((y_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_train <span class="op">==</span> <span class="dv">0</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    X_train[<span class="st">"FN"</span>] <span class="op">=</span> ((y_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_train <span class="op">==</span> <span class="dv">1</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculating the profit gain and loss for each borrower using the formulas provided by Prof. Chodrow</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    profit_gain <span class="op">=</span> X_train[<span class="st">"TN"</span>] <span class="op">*</span> (X_train[<span class="st">"loan_amnt"</span>] <span class="op">*</span> ((<span class="dv">1</span> <span class="op">+</span> (<span class="fl">0.25</span> <span class="op">*</span> (X_train[<span class="st">"loan_int_rate"</span>] <span class="op">/</span> <span class="dv">100</span>))) <span class="op">**</span> <span class="dv">10</span>) <span class="op">-</span> X_train[<span class="st">"loan_amnt"</span>])</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    profit_loss <span class="op">=</span> X_train[<span class="st">"FN"</span>] <span class="op">*</span> (X_train[<span class="st">"loan_amnt"</span>] <span class="op">*</span> ((<span class="dv">1</span> <span class="op">+</span> (<span class="fl">0.25</span> <span class="op">*</span> (X_train[<span class="st">"loan_int_rate"</span>] <span class="op">/</span> <span class="dv">100</span>))) <span class="op">**</span> <span class="dv">3</span>) <span class="op">-</span> (<span class="fl">1.7</span> <span class="op">*</span> X_train[<span class="st">"loan_amnt"</span>]))</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Profit-per-borrower with the current threshold</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    ppb <span class="op">=</span> (profit_gain <span class="op">+</span> profit_loss).<span class="bu">sum</span>() <span class="op">/</span> X_train.shape[<span class="dv">0</span>]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ploting PPB point and updating variables</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    ax.scatter(t, ppb, color <span class="op">=</span> <span class="st">"purple"</span>, s <span class="op">=</span> <span class="fl">12.5</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ppb <span class="op">&gt;</span> best_ppb: </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        best_ppb <span class="op">=</span> ppb</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        best_threshold <span class="op">=</span> t</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot styling</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>ax.axvline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"darkorange"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>, zorder <span class="op">=</span> <span class="op">-</span><span class="dv">10</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> ax.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="vs">r"Threshold $t$"</span>, ylabel <span class="op">=</span> <span class="st">"Bank Profit (Per Borrower)"</span>, title <span class="op">=</span> <span class="st">"Profit Per Borrower by Threshold"</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>ax.text(<span class="fl">0.75</span>, <span class="dv">500</span>, <span class="ss">f"Best Profit: $</span><span class="sc">{</span>best_ppb<span class="sc">: .2f}</span><span class="ch">\n</span><span class="ss">  At Threshold $t = $</span><span class="sc">{</span>best_threshold<span class="sc">: .3f}</span><span class="ss">"</span>, ha <span class="op">=</span> <span class="st">"center"</span>,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"grey"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><em>In the code above, the bank’s profit-per-borrower is plotted against the threshold <span class="math inline">\(t\)</span>. The profit per borrower is determined by calculating the profit gain and profit loss (using the formulas provided by Prof.&nbsp;Chordow) for each individual loan. The correct profit value (either gain or loss) is then added to the overall profit sum depending on whether or not the model correctly classified a given loan as a true negative or incorrectly classified a given loan as a false negative. The overall profit is then divided by the number of observations (borrowers) in the training data to yield the profit value per borrower.</em></p>
<p><strong>Figure 6</strong></p>
<p>As depicted above, the bank’s profit-per-borrower is shown to increase as the threshold <span class="math inline">\(t\)</span> increases before notably dropping and ultimately plateauing. The bank’s peak profit-per-borrower is approximately <span class="math inline">\(\$1450.00\)</span>, corresponding to using a threshold value of <span class="math inline">\(t = 0.495\)</span>. Not surprisingly, both the model’s overall accuracy as well as the bank’s profit-per-borrower are maximized at very similar thresholds (about 0.5).</p>
</section>
</section>
<section id="model-evaluation" class="level1">
<h1>Model Evaluation</h1>
<section id="perspective-of-the-bank" class="level2">
<h2 class="anchored" data-anchor-id="perspective-of-the-bank">Perspective of the Bank</h2>
<div id="cell-32" class="cell" data-execution_count="255">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in and modifying the test data</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> pd.read_csv(<span class="st">"https://raw.githubusercontent.com/PhilChodrow/ml-notes/main/data/credit-risk/test.csv"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> test.dropna()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>Xt <span class="op">=</span> test.drop([<span class="st">"loan_status"</span>, <span class="st">"loan_grade"</span>], axis <span class="op">=</span> <span class="dv">1</span>, errors <span class="op">=</span> <span class="st">"ignore"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> test[<span class="st">"loan_status"</span>]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating one-hot encodings for qualitative variables</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>Xt <span class="op">=</span> pd.get_dummies(Xt, drop_first <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing NAs from data while maintaining alignment</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>clean <span class="op">=</span> pd.concat([Xt, yt], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>clean <span class="op">=</span> clean.dropna()</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> clean.drop(<span class="st">"loan_status"</span>, axis <span class="op">=</span> <span class="dv">1</span>, errors <span class="op">=</span> <span class="st">"ignore"</span>).copy()</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> clean[<span class="st">"loan_status"</span>].copy()</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Computing and normalizing the test scores</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>test_scores <span class="op">=</span> lin_score(X_test[best_vars], w)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizing the scores</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>test_scores <span class="op">=</span> (test_scores <span class="op">-</span> scores.<span class="bu">min</span>()) <span class="op">/</span> (test_scores.<span class="bu">max</span>() <span class="op">-</span> test_scores.<span class="bu">min</span>())</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding the model's calculated score for each observation in the testing data</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>test[<span class="st">"score"</span>] <span class="op">=</span> test_scores</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>test[<span class="st">"score"</span>] <span class="op">=</span> pd.to_numeric(test[<span class="st">"score"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determining predictions</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>y_test_pred <span class="op">=</span> test_scores <span class="op">&gt;=</span> best_threshold</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the profit-per-borrower for test data (copied from code chunk above)</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Determining whether each prediction is a a true or false negative to inform the amount of profit loss or gain for a given loan</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>X_test[<span class="st">"TN"</span>] <span class="op">=</span> ((y_test_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">0</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>X_test[<span class="st">"FN"</span>] <span class="op">=</span> ((y_test_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">1</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the profit gain and loss for each borrower using the foromulas provided by Prof. Chodrow</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>profit_gain_t <span class="op">=</span> X_test[<span class="st">"TN"</span>] <span class="op">*</span> (X_test[<span class="st">"loan_amnt"</span>] <span class="op">*</span> ((<span class="dv">1</span> <span class="op">+</span> (<span class="fl">0.25</span> <span class="op">*</span> (X_test[<span class="st">"loan_int_rate"</span>] <span class="op">/</span> <span class="dv">100</span>))) <span class="op">**</span> <span class="dv">10</span>) <span class="op">-</span> X_test[<span class="st">"loan_amnt"</span>])</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>profit_loss_t <span class="op">=</span> X_test[<span class="st">"FN"</span>] <span class="op">*</span> (X_test[<span class="st">"loan_amnt"</span>] <span class="op">*</span> ((<span class="dv">1</span> <span class="op">+</span> (<span class="fl">0.25</span> <span class="op">*</span> (X_test[<span class="st">"loan_int_rate"</span>] <span class="op">/</span> <span class="dv">100</span>))) <span class="op">**</span> <span class="dv">3</span>) <span class="op">-</span> (<span class="fl">1.7</span> <span class="op">*</span> X_test[<span class="st">"loan_amnt"</span>]))</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit-per-borrower for test data using the best threshold</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>ppbt <span class="op">=</span> (profit_gain_t <span class="op">+</span> profit_loss_t).<span class="bu">sum</span>() <span class="op">/</span> X_test.shape[<span class="dv">0</span>]</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The Bank's Profit-Per-Borrower from the test data: $</span><span class="sc">{</span>ppbt <span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"(Test Data PPB to Training Data PPB Ratio: </span><span class="sc">{</span>((ppbt <span class="op">/</span> best_ppb) <span class="op">*</span> <span class="dv">100</span>)<span class="sc">: .2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The Bank's Profit-Per-Borrower from the test data: $1326.67
(Test Data PPB to Training Data PPB Ratio:  91.64%)</code></pre>
</div>
</div>
<p><em>In the code above, the test data is processed the exact same way as the training data to ensure compatibility with the scoring function and profit-per-borrower calculations as previously done.</em></p>
<p>According to the computation above, the bank’s expected profit-per-borrower on the test data is approximately <span class="math inline">\(\$1330.00\)</span>. This value is roughly <span class="math inline">\(92\%\)</span> of (i.e.&nbsp;considerably similar to) the profit-per-borrower produced by the training data. Consider the most popular loan intent from the test data: Educational loans. According to the statistics provided by the <a href="https://educationdata.org/student-loan-debt-statistics#:~:text=Report%20Highlights.,borrowers%20have%20federal%20loan%20debt.">Education Data Initiative</a>, there were nearly 43 million student loan borrowers in the US in 2024. Additionally, <a href="https://www.mx.com/blog/biggest-banks-by-asset-size-united-states/">MX Technologies</a> reports there being about 4550 banks in the US. If the number of US educational loan borrowers is divided amongst the number of US banks, each US bank could have approximately 9450 educational loan borrowers in 2024. So suppose the hypothetical bank in this study has about 9450 educational loan borrowers. Thus, the bank’s profit (theoretically in 2024) from educational loans alone would be about $12.57 million. This is of course a wildly crude calculation that is ultimately not based on any reviewed methodology. But, it at least goes to show how large the hypothetical bank’s annual profit theoretically could be, even for only one type of loan.</p>
</section>
<section id="perspective-of-the-borrower" class="level2">
<h2 class="anchored" data-anchor-id="perspective-of-the-borrower">Perspective of the Borrower</h2>
<section id="loan-approval-and-borrower-age" class="level4">
<h4 class="anchored" data-anchor-id="loan-approval-and-borrower-age">Loan Approval and Borrower Age</h4>
<div id="cell-35" class="cell" data-execution_count="256">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to convert numerical ages to age categories</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> age_cat(age):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (age <span class="op">&lt;</span> <span class="dv">30</span>):</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Young Adult"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> (age <span class="op">&lt;</span> <span class="dv">60</span>):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Adult"</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Senior"</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>test[<span class="st">"age_cat"</span>] <span class="op">=</span> test[<span class="st">"person_age"</span>].<span class="bu">apply</span>(age_cat)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Independent and dependent variables for bar chart</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>age_cats <span class="op">=</span> np.array(test[<span class="st">"age_cat"</span>].unique())</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(age_cats)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Avg. scores calculated using .groupby(...).aggregate(...)</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>ac_avg_scores <span class="op">=</span> np.array([</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Young Adult"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Adult"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Senior"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>age_scores_df <span class="op">=</span> pd.DataFrame({<span class="st">"Age Cat"</span>: age_cats, <span class="st">"Avg Score"</span>: ac_avg_scores})</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrays of percentage of high scores and percentage of all scores above the threshold from each age cat</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>num_high_scores <span class="op">=</span> (test[<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).<span class="bu">sum</span>()</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Perc. of high scores among each age cat</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>ac_perc_high_scores_1 <span class="op">=</span> np.array([(test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Young Adult"</span>][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).mean() <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                           (test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Adult"</span>][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).mean() <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>                           (test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Senior"</span>][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).mean() <span class="op">*</span> <span class="dv">100</span>])</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Perc. of all high scores contributed by each age cat</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>ac_perc_high_scores_2 <span class="op">=</span> np.array([(test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Young Adult"</span>][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).<span class="bu">sum</span>(), </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                           (test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Adult"</span>][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).<span class="bu">sum</span>(), </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                           (test[test[<span class="st">"age_cat"</span>] <span class="op">==</span> <span class="st">"Senior"</span>][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).<span class="bu">sum</span>()])</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying average model score for each age cat</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="fl">12.5</span>))</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"seaborn-v0_8-whitegrid"</span>)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of scores by age cat</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>sns.boxenplot(test, x <span class="op">=</span> <span class="st">"age_cat"</span>, y <span class="op">=</span> <span class="st">"score"</span>, hue <span class="op">=</span> <span class="st">"age_cat"</span>, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].axhline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">"Distribution of Model Scores"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"Score (Normalized)"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_xticklabels([<span class="st">"Young Adult</span><span class="ch">\n</span><span class="st">(Early-Career)"</span>, <span class="st">"Adult</span><span class="ch">\n</span><span class="st">(Mid-Career)"</span>, <span class="st">"Senior</span><span class="ch">\n</span><span class="st">(Late-Career/Retired)"</span>])</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].text(<span class="fl">1.75</span>, <span class="fl">0.85</span>, <span class="ss">f"     $t = 0.495$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].text(<span class="fl">1.5</span>, <span class="fl">0.85</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, ha <span class="op">=</span> <span class="st">"left"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Average score by age cat</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>sns.barplot(x <span class="op">=</span> age_cats, y <span class="op">=</span> ac_avg_scores, data <span class="op">=</span> age_scores_df, hue <span class="op">=</span> age_cats, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].axhline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>)</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">"Average Model Score"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"Average Score (Normalized)"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels([<span class="st">"Young Adult</span><span class="ch">\n</span><span class="st">(Early-Career)"</span>, <span class="st">"Adult</span><span class="ch">\n</span><span class="st">(Mid-Career)"</span>, <span class="st">"Senior</span><span class="ch">\n</span><span class="st">(Late-Career/Retired)"</span>])</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].text(<span class="fl">1.75</span>, <span class="fl">0.425</span>, <span class="ss">f"     $t = 0.495$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].text(<span class="fl">1.5</span>, <span class="fl">0.425</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, ha <span class="op">=</span> <span class="st">"left"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Percentage of high scores (above threshold) for each age cat</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>sns.barplot(x <span class="op">=</span> age_cats, y <span class="op">=</span> ac_perc_high_scores_1, hue <span class="op">=</span> age_cats, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">"Percentage of Model Scores</span><span class="ch">\n</span><span class="st">Above Threshold "</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f Scores Above Threshold"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_xticklabels([<span class="st">"Young Adult</span><span class="ch">\n</span><span class="st">(Early-Career)"</span>, <span class="st">"Adult</span><span class="ch">\n</span><span class="st">(Mid-Career)"</span>, <span class="st">"Senior</span><span class="ch">\n</span><span class="st">(Late-Career/Retired)"</span>])</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_yticks([<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">12</span>])</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_yticklabels([<span class="st">"0%"</span>, <span class="st">"2%"</span>, <span class="st">"4%"</span>, <span class="st">"6%"</span>, <span class="st">"8%"</span>, <span class="st">"10%"</span>, <span class="st">"12%"</span>])</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Percentage of all high scores (above threshold) from each age cat</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>sns.barplot(x <span class="op">=</span> age_cats, y <span class="op">=</span> ((ac_perc_high_scores_2 <span class="op">/</span> num_high_scores) <span class="op">*</span> <span class="dv">100</span>), hue <span class="op">=</span> age_cats, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">"Percentage of all Model Scores</span><span class="ch">\n</span><span class="st">Above Threshold From each Age Category"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f all Scores Above Threshold"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_xticklabels([<span class="st">"Young Adult</span><span class="ch">\n</span><span class="st">(Early-Career)"</span>, <span class="st">"Adult</span><span class="ch">\n</span><span class="st">(Mid-Career)"</span>, <span class="st">"Senior</span><span class="ch">\n</span><span class="st">(Late-Career/Retired)"</span>])</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_yticks([<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>])</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_yticklabels([<span class="st">"0%"</span>, <span class="st">"10%"</span>, <span class="st">"20%"</span>, <span class="st">"30%"</span>, <span class="st">"40%"</span>, <span class="st">"50%"</span>, <span class="st">"60%"</span>, <span class="st">"70%"</span>, <span class="st">"80%"</span>])</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="st">"Model Score Metrics by Borrower Age category"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.05</span>, <span class="st">"Borrower Age Category"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(wspace <span class="op">=</span> <span class="fl">0.25</span>, hspace <span class="op">=</span> <span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>['Young Adult' 'Adult' 'Senior']</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><em>Code above constructs 4 plots to observe how the model score varies across age category among borrowers. The top two plots simply display the distribution of model scores and the average score for each age category. The bottom two plots show the percentage of high model scores within each age category and the percentage of overall high model scores attributed to each age category (computed by taking the number of high model scores for each age category over the total number of high model scores).</em></p>
<p><strong>Figure 7</strong></p>
<p>As displayed in the plots above, it appears that young adults and middle-aged borrowers receive lower scores than senior borrowers. Additionally, a smaller percentage of scores for both young adult and middle-aged borrowers are above the threshold than that of senior borrowers. Considering this, it is reasonable to hypothesize that the model makes it more difficult for older borrowers to be approved for loans than it is for younger borrowers. However, this is possibly a result of inconsistent age category sizes. That is, the percentage of all high scores (scores that advise the bank to deny a borrower a loan) attributed to young adults is much greater than that of middle-aged and senior borrowers. It is possible that the metrics found in this data are not truly representative of the population of senior borrowers.</p>
</section>
<section id="loan-approval-and-loan-intent" class="level4">
<h4 class="anchored" data-anchor-id="loan-approval-and-loan-intent">Loan Approval and Loan Intent</h4>
<div id="cell-38" class="cell" data-execution_count="257">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Independent and dependent variables for bar chart</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>loan_intents <span class="op">=</span> np.array(test[<span class="st">"loan_intent"</span>].unique())</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Avg. scores calculated using .groupby(...).aggregate(...)</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>li_avg_scores <span class="op">=</span> np.array([</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"VENTURE"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"DEBTCONSOLIDATION"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"MEDICAL"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"HOMEIMPROVEMENT"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"EDUCATION"</span>][<span class="st">"score"</span>].mean(),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"PERSONAL"</span>][<span class="st">"score"</span>].mean()</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>li_scores_df <span class="op">=</span> pd.DataFrame({<span class="st">"Loan Intent"</span>: loan_intents, <span class="st">"Avg Score"</span>: li_avg_scores})</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrays of percentage of high scores and percentage of all scores above the threshold from each loan intent</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>li_perc_high_scores_1 <span class="op">=</span> np.zeros(<span class="dv">0</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>li_perc_high_scores_2 <span class="op">=</span> np.zeros(<span class="dv">0</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> loan <span class="kw">in</span> loan_intents:</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculating each metric</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    li_perc_high_score_1 <span class="op">=</span> (test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> loan][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    li_perc_high_score_2 <span class="op">=</span> ((test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> loan][<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold).<span class="bu">sum</span>() <span class="op">/</span> num_high_scores) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adding each metric to corresponding array</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    li_perc_high_scores_1 <span class="op">=</span> np.append(li_perc_high_scores_1, li_perc_high_score_1)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    li_perc_high_scores_2 <span class="op">=</span> np.append(li_perc_high_scores_2, li_perc_high_score_2)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying average model score for each age cat</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="fl">12.5</span>))</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"seaborn-v0_8-whitegrid"</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of scores by age cat</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>sns.boxenplot(test, x <span class="op">=</span> <span class="st">"loan_intent"</span>, y <span class="op">=</span> <span class="st">"score"</span>, hue <span class="op">=</span> <span class="st">"loan_intent"</span>, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].axhline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">"Distribution of Model Scores"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"Score (Normalized)"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span> ,<span class="dv">5</span>])</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_xticklabels(loan_intents, rotation <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].text(<span class="dv">4</span>, <span class="fl">0.9</span>, <span class="ss">f"     $t = 0.495$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">0</span>].text(<span class="fl">3.5</span>, <span class="fl">0.9</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, ha <span class="op">=</span> <span class="st">"left"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Average score by age cat</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>sns.barplot(x <span class="op">=</span> loan_intents, y <span class="op">=</span> li_avg_scores, data <span class="op">=</span> li_scores_df, hue <span class="op">=</span> loan_intents, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].axhline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">"Average Model Score"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"Average Score (Normalized)"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>])</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(loan_intents, rotation <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].text(<span class="dv">4</span>, <span class="fl">0.45</span>, <span class="ss">f"     $t = 0.495$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>, <span class="dv">1</span>].text(<span class="fl">3.5</span>, <span class="fl">0.45</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, ha <span class="op">=</span> <span class="st">"left"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Percentage of high scores (above threshold) for each age cat</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>sns.barplot(x <span class="op">=</span> loan_intents, y <span class="op">=</span> li_perc_high_scores_1, hue <span class="op">=</span> loan_intents, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">"Percentage of Model Scores</span><span class="ch">\n</span><span class="st">Above Threshold "</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f Scores Above Threshold"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>])</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_xticklabels(loan_intents, rotation <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_yticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>])</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">0</span>].set_yticklabels([<span class="st">"0%"</span>, <span class="st">"1%"</span>, <span class="st">"2%"</span>, <span class="st">"3%"</span>, <span class="st">"4%"</span>, <span class="st">"5%"</span>, <span class="st">"6%"</span>, <span class="st">"7%"</span>, <span class="st">"8%"</span>])</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Percentage of all high scores (above threshold) from each age cat</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>sns.barplot(x <span class="op">=</span> loan_intents, y <span class="op">=</span> li_perc_high_scores_2, hue <span class="op">=</span> loan_intents, legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">"Percentage of all Model Scores</span><span class="ch">\n</span><span class="st">Above Threshold From each Age Category"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f all Scores Above Threshold"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_xticks([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>])</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_xticklabels(loan_intents, rotation <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_yticks([<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>])</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>, <span class="dv">1</span>].set_yticklabels([<span class="st">"0%"</span>, <span class="st">"5%"</span>, <span class="st">"10%"</span>, <span class="st">"15%"</span>, <span class="st">"20%"</span>])</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="st">"Model Score Metrics by Loan Intent"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.05</span>, <span class="st">"Loan Intent"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(wspace <span class="op">=</span> <span class="fl">0.25</span>, hspace <span class="op">=</span> <span class="fl">0.35</span>)</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Computing true defualt rates for medical, venture, and educational loans</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"MEDICAL"</span>].copy()</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"VENTURE"</span>].copy()</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>e <span class="op">=</span> test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"EDUCATION"</span>].copy()</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"DEBTCONSOLIDATION"</span>].copy()</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"PERSONAL"</span>].copy()</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> test[test[<span class="st">"loan_intent"</span>] <span class="op">==</span> <span class="st">"HOMEIMPROVEMENT"</span>].copy()</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>true_default_rates <span class="op">=</span> np.array([</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>    (m[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean(),</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>    (v[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean(),</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>    (e[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean(),</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>    (d[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean(),</span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>    (p[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean(),</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>    (h[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean(),</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><em>Code above constructs 4 plots to observe how the model score varies across loan intent. The top two plots simply display the distribution of model scores and the average score for each loan intent. The bottom two plots show the percentage of high model scores within each loan intent and the percentage of overall high model scores attributed to each loan intent (computed by taking the number of high model scores for each loan intent over the total number of high model scores).</em></p>
<p><strong>Figure 8</strong></p>
<p>As shown in the figures above, the the general distribution and average model scores across each loan intent are considerably similar. That is, it does not appear that any specific loan intents correspond to significantly high or low model scores. However, as shown in the bottom right plot, the largest percentage of all high model scores (scores that advise the bank to deny a borrower a loan), is attributed to medical loans. This may suggest that it is more difficult for borrowers to have medical loans approved. The actual rate of default for medical loans in the test data is about <span class="math inline">\(30\%\)</span>, which is the second highest default rate (nearly equal to that of debt consolidation loans). Considering that medical loans make up the largest percentage of overall high model scores and have the highest true rate of default in the test data, it may be justified that the bank makes it more difficult for borrowers seeking these types of loans to be approved.</p>
<p>As for venture and educational loans, it appears that borrowers looking to take out these types of loans are similarly likely to be approved by the bank (they have very similar average model scores, percentage of high scores within themselves, and percentage makeups of the overall high model scores). Additionally, both venture loans and educational loans have similar default rates in the test data of about <span class="math inline">\(15\%\)</span> and <span class="math inline">\(17\%\)</span> respectively.</p>
</section>
<section id="loan-approval-and-borrower-income" class="level4">
<h4 class="anchored" data-anchor-id="loan-approval-and-borrower-income">Loan Approval and Borrower Income</h4>
<div id="cell-41" class="cell" data-execution_count="258">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding high/low score indicator col</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>test[<span class="st">"high_score"</span>] <span class="op">=</span> test[<span class="st">"score"</span>] <span class="op">&gt;=</span> best_threshold</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>test[<span class="st">"low_inc"</span>] <span class="op">=</span> (test[<span class="st">"person_income"</span>] <span class="op">&lt;=</span> <span class="dv">30000</span>).astype(<span class="bu">int</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>test[<span class="st">"high_inc"</span>] <span class="op">=</span> (test[<span class="st">"person_income"</span>] <span class="op">&gt;=</span> <span class="dv">150000</span>).astype(<span class="bu">int</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>test[<span class="st">"person_inc_log"</span>] <span class="op">=</span> np.log2(test[<span class="st">"person_income"</span>])</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>low_inc <span class="op">=</span> test[test[<span class="st">"low_inc"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>high_inc <span class="op">=</span> test[test[<span class="st">"high_inc"</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting model score against borrower income</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize <span class="op">=</span> (<span class="fl">17.5</span>, <span class="dv">10</span>))</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Score by income for low income borrowers</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data <span class="op">=</span> low_inc, x <span class="op">=</span> <span class="st">"person_income"</span>, y <span class="op">=</span> <span class="st">"score"</span>, hue <span class="op">=</span> <span class="st">"high_score"</span>, palette <span class="op">=</span> [<span class="st">"darkorange"</span>, <span class="st">"purple"</span>], legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Low Income"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"Score (Normalized)"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xticks([<span class="fl">5e3</span>, <span class="fl">10e3</span>, <span class="fl">15e3</span>, <span class="fl">20e3</span>, <span class="fl">25e3</span>, <span class="fl">30e3</span>])</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xticklabels([<span class="st">"~$5000"</span>, <span class="st">"~$10000"</span>, <span class="st">"~$15000"</span>, <span class="st">"~$20000"</span>, <span class="st">"~$25000"</span>, <span class="st">"~$30000"</span>], rotation <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].axhline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].text(<span class="dv">8000</span>, <span class="fl">0.9</span>, <span class="ss">f"     $t = 0.495$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].text(<span class="dv">5000</span>, <span class="fl">0.9</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, ha <span class="op">=</span> <span class="st">"left"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Score by income for high income borrowers</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data <span class="op">=</span> high_inc, x <span class="op">=</span> <span class="st">"person_income"</span>, y <span class="op">=</span> <span class="st">"score"</span>, hue <span class="op">=</span> <span class="st">"high_score"</span>, palette <span class="op">=</span> [<span class="st">"darkorange"</span>, <span class="st">"purple"</span>], legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xscale(<span class="st">"log"</span>, base <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"High Income"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">""</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xticks([<span class="dv">2</span> <span class="op">**</span> <span class="dv">18</span>, <span class="dv">2</span> <span class="op">**</span> <span class="dv">19</span>, <span class="dv">2</span> <span class="op">**</span> <span class="dv">20</span>])</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xticklabels([<span class="st">"~$260000"</span>, <span class="st">"~$500000"</span>, <span class="st">"~$1M"</span>], rotation <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].axhline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].text(<span class="dv">2</span> <span class="op">**</span> <span class="fl">17.75</span>, <span class="fl">0.45</span>, <span class="ss">f"     $t = 0.495$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].text(<span class="dv">2</span> <span class="op">**</span> <span class="fl">17.325</span>, <span class="fl">0.45</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, ha <span class="op">=</span> <span class="st">"left"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Score by income for all borrowers</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data <span class="op">=</span> test, x <span class="op">=</span> <span class="st">"person_income"</span>, y <span class="op">=</span> <span class="st">"score"</span>, hue <span class="op">=</span> <span class="st">"high_score"</span>, palette <span class="op">=</span> [<span class="st">"darkorange"</span>, <span class="st">"purple"</span>], legend <span class="op">=</span> <span class="va">False</span>, ax <span class="op">=</span> ax[<span class="dv">2</span>])</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_xscale(<span class="st">"log"</span>, base <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_title(<span class="st">"All Borrowers"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_ylabel(<span class="st">""</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_xlabel(<span class="st">""</span>)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_xticks([<span class="dv">2</span> <span class="op">**</span> <span class="dv">13</span>, <span class="dv">2</span> <span class="op">**</span> <span class="dv">15</span>, <span class="dv">2</span> <span class="op">**</span> <span class="dv">17</span>, <span class="dv">2</span> <span class="op">**</span> <span class="dv">19</span>, <span class="dv">2</span> <span class="op">**</span> <span class="dv">21</span>])</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].set_xticklabels([<span class="st">"~$8000"</span>, <span class="st">"~$30000"</span>, <span class="st">"~$100000"</span>, <span class="st">"~$500000"</span>, <span class="st">"~$2M"</span>], rotation <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].axhline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, linewidth <span class="op">=</span> <span class="fl">2.5</span>)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].text(<span class="dv">2</span> <span class="op">**</span> <span class="dv">18</span>, <span class="fl">0.9</span>, <span class="ss">f"     $t = 0.495$"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">10</span>, </span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> <span class="bu">dict</span>(facecolor <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, edgecolor <span class="op">=</span> <span class="st">"gray"</span>, boxstyle <span class="op">=</span> <span class="st">"round,pad=0.3"</span>))</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].text(<span class="dv">2</span> <span class="op">**</span> <span class="dv">17</span>, <span class="fl">0.9</span>, <span class="st">"</span><span class="ch">\u2013</span><span class="st">"</span>, color <span class="op">=</span> <span class="st">"purple"</span>, ha <span class="op">=</span> <span class="st">"left"</span>, va <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Observing Model Score Against Borrower Income"</span>, fontsize <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.01</span>, <span class="st">"Borrower Income ($\log_2$ scale on rightmost subplots)"</span>, ha <span class="op">=</span> <span class="st">"center"</span>, fontsize <span class="op">=</span> <span class="dv">16</span>)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating default rates for low and high income borrowers</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>true_default_rates_inc <span class="op">=</span> np.array([</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    (low_inc[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean(),</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    (high_inc[<span class="st">"loan_status"</span>] <span class="op">==</span> <span class="dv">1</span>).mean()</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><em>Code above constructs scatter plots observing model score by borrower income for low-income borrowers, high-income borrowers, and all borrowers. The threshold is included in each plot to depict where the score cutoff is.</em></p>
<p><strong>Figure 9</strong></p>
<p>As depicted in the plots above, there seems to be a general trend between borrower income and their corresponding model score. That is, it appears that as a borrower’s income increases, their score decreases. This may suggest that the model makes it easier for higher-income individuals to be approved for loans than those at lower-income levels. This is supported by the fact that a considerable proportion of low-income borrowers (<span class="math inline">\(\leq \$30000\)</span> annual earnings) were scored above the threshold (i.e.&nbsp;likely not approved) while none of the high-income borrowers (<span class="math inline">\(\geq \$150000\)</span> annual earnings) were scored above the threshold. This may be sufficient evidence for the bank, but it is important to note that a borrower’s income is not actually one of the features the model was trained on. Thus, this observation may be due to other related factors.</p>
</section>
</section>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>The goal of this study was to experiment with the construction of an automated decision model for a binary decision circumstance, and to examine how this model classified the data based on its various features. At a higher level, this study allowed me to gain some hands-on experience tweaking and interpreting the characteristics of a completely automated classification model. This has provided me with a fulfilling opportunity to investigate how models sculpt their decision-making parameters based both on the data and the intentions of the model designer – Ultimately exploring how this model might treat people (data observations) with different relevant (or irrelevant) qualities to the decision-making task. While conducting this analysis, I had the opportunity to deepen my understanding of feature selection processes for model training, designing a scoring function, establishing a threshold to maximize certain values, and using a model to develop understandings of how it treats unseen data.</p>
<p>As described in the sections above, some of the most notable results from this study include: 1. The model appears to make loan approval easier for younger borrowers as opposed to older ones; 2. Out of all loan intents, the model makes it most difficult for borrowers seeking medical loans to get approval; 3. The model seems to make it easier for higher-income borrowers to be approved for loans than those of lower-income. As far as “fairness” with this model is concerned. I feel that there are two reasonable and opposing arguments to be made regarding the actions hypothetical bank based on using the model from this study. Firstly, it is important to note that the model is designed from the perspective of the bank and thus aims at achieving the ultimate goal of maximizing the bank’s interests (seemingly profit-per-borrower). With this in mind, the model seems to make loan approval more difficult for lower-income borrowers and or borrowers seeking medical loans while the default rates for each of these categories are highest (or at least nearly so) among their respective groups. In this sense, the model behaves logically and arguably “fairly”. E.g: Sure, medical loans are less likely to be repaid, so it’s reasonable to make them harder to approve. However, this behavior of the model allows for impactful and harmful decisions to be made upon certain individuals without taking into account the vast collection of reasons why these borrowers are considered more “risky” by the model. Personally, I think the most useful model is one that is designed to be used by the bank but with the intentions of assisting the borrower. That is, I would argue that this model should have some sort of “loan severity” parameter that provides information about the necessity of a given loan. With such a parameter in place, a borrower’s low-income status, higher age, or medical matters need not necessarily withhold them from financial assistance that would otherwise be given to more fortunate borrowers looking to make personal or business advancements. Considering this other approach, I would define “fairness” in this context as the model making decisions about loan approval with some sort of information pertaining to the loan necessity for a given borrower. That is, the model would decide loan approval based on both financial and need-based characteristics of borrowers. Until the model operates under these or similar conditions, I personally feel that it is not particularly “fair”.</p>
<p>Above all, the question of “fairness” exercised by the model in this study extends to the larger concept of ethical machine learning. Forming a strict definition of fairness is rarely easy and often not intuitive in the context of many applications of ML models and algorithms. Yet, it will always remain a crucial part of ML model and algorithm design to deeply consider how fairness bears significance in a given ML application, especially when systemic biases and injustices may be at play.</p>
<p><em>During the implementation process of this blog post, I collaborated with Andrew Dean.</em></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>